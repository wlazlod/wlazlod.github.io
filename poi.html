<!doctype html>
<html lang="pl">
  <head>
  	<title>Świdnik - mapa mobilności</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">
		
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/style.css">
		<script src="js/echarts.min.js"></script>
		
  </head>
  <body>
		
		<div class="wrapper d-flex align-items-stretch">
			<nav id="sidebar">
				<div class="custom-menu">
					<button type="button" id="sidebarCollapse" class="btn btn-primary">
	          <i class="fa fa-bars"></i>
	          <span class="sr-only">Toggle Menu</span>
	        </button>
        </div>
				<div class="p-4">
		  		<h1><a href="index.html" class="logo">Świdnik <span>Wspomaganie mobilności</span></a></h1>
	        <ul class="list-unstyled components mb-5">
	          <li>
	            <a href="index.html"><span class="fa fa-map-o mr-3"></span> Mapa Mobilności</a>
	          </li>
			  <li>
                <a href="#groupSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle"><span class="fa fa-briefcase mr-3"></span> Grupy POI</a>
                <ul class="collapse list-unstyled" id="groupSubmenu">
                    <li>
						<a href="#buildingsSubSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Budynki</a>
						<ul class="collapse list-unstyled" id="buildingsSubSubmenu">
							<li>
								<a href="groups_template.html">Centra handlowe</a>
							</li>
							<li>
								<a href="groups_template.html">Kościoły</a>
							</li>
							<li>
								<a href="groups_template.html">Szkoły</a>
							</li>
							<li>
								<a href="groups_template.html">Urzędy</a>
							</li>
							<li>
								<a href="groups_template.html">Zakłady Pracy</a>
							</li>
						</ul>
					</li>
					<li>
                        <a href="groups_template.html">Parki</a>
                    </li>
					<li>
                        <a href="groups_template.html">Przystanki</a>
                    </li>
                    <li>
                        <a href="groups_template.html">Ulice</a>
                    </li>
                    <li>
                        <a href="groups_template.html">Ścieżki rowerowe</a>
                    </li>
                </ul>
			  </li>
	          <li>
				<a href="poi.html?id=1&name=Park%20Brzeziny" class="active"><span class="fa fa-sticky-note mr-3"></span>POI</a>
	          </li>
			  <li>
	            <a href="add.html"><span class="fa fa-camera-retro mr-3"></span>Rozpoznawanie obiektów</a>
	          </li>
			  <li>
	            <a href="about.html"><span class="fa fa-user mr-3"></span>O projekcie</a>
	          </li>
	          <li>
				<a href="contact.html"><span class="fa fa-paper-plane mr-3"></span>Kontakt</a>
	          </li>
	        </ul>

	        <div class="footer">
	        	<p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
						  Copyright AiRonmen &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved 
						  <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p>
	        </div>

	      </div>
    	</nav>

        <!-- Page Content  -->
      <div id="content" class="p-4 p-md-5 pt-5">
        <h2 class="mb-4" id="name"></h2>
		
			<script>
				const queryString = window.location.search;

				const urlParams = new URLSearchParams(queryString);
				const id = urlParams.get('id')
				
			
				document.getElementById("name").innerHTML = name;
				
				var xhr = new XMLHttpRequest();
				var url = "http://ec2-18-188-99-138.us-east-2.compute.amazonaws.com:8988/poi_info?data=%7B%22poi_id%22:%22" + id +"%22%7D";
				xhr.open("GET", url, true);
				
				xhr.send();
				
				xhr.onload = function() {
					if (xhr.status != 200) { // analyze HTTP status of the response
						name = "Nieznany POI";
						alert(`Error ${xhr.status}: ${xhr.statusText}`); // e.g. 404: Not Found
					} else { // show the result
						answer = JSON.parse(xhr.responseText);
						console.log(JSON.parse(xhr.responseText))
						name = answer.poi_name;
						barChartBus(answer.bus_occupancy)
						chartSeries(answer.car_occupancy)
					}
					document.getElementById("name").innerHTML = name;
					
				};
				
				

        // specify chart configuration item and data
				
				function timeConverter(UNIX_timestamp){
					  var a = new Date(UNIX_timestamp * 1000);
					  var year = a.getFullYear();
					  var month = a.getMonth();
					  var date = a.getDate();
					  var hour = a.getHours();
					  var min = a.getMinutes();
					  var sec = a.getSeconds();
					  var time = year + '/' + month + '/' + date
					  return time;
				}
				
				function barChartBus(data) {
				
					var myChart = echarts.init(document.getElementById('barchart'));
					
					console.log(data)
					data_list = [['Data', 'Liczba pasażerów na przystanku']]
					for (x of data) {
						data_list = data_list.concat([[timeConverter(x.ts), x.val]])
					}
					console.log(data_list)
					
					var option = {
						legend: {},
						tooltip: {},
						dataset: {
							source: data_list
						},
						xAxis: {type: 'category'},
						yAxis: {},
						// Declare several bar series, each will be mapped
						// to a column of dataset.source by default.
						series: [
							{type: 'bar'}
						]
					};


					// use configuration item and data specified to show chart
					myChart.setOption(option);
					
					window.onresize = function() {
						myChart.resize();
					};
				}
				
				function chartSeries(data){
					var dom = document.getElementById("piecalendar");
					var myChart = echarts.init(dom);
					var app = {};
					option = null;
					var cellSize = [60, 60];
					var pieRadius = 25;

					function getVirtulData() {
						var date = +echarts.number.parseDate('2017-02-01');
						var end = +echarts.number.parseDate('2017-03-01');
						var dayTime = 3600 * 24 * 1000;
						var data = [];
						for (var time = date; time < end; time += dayTime) {
							data.push([
								echarts.format.formatTime('yyyy-MM-dd', time),
								Math.floor(Math.random() * 10000)
							]);
						}
						return data;
					}

					function getPieSeries(scatterData, chart) {
						return echarts.util.map(scatterData, function (item, index) {
							var center = chart.convertToPixel('calendar', item);
							return {
								id: index + 'pie',
								type: 'pie',
								center: center,
								label: {
									normal: {
										formatter: '{c}',
										position: 'inside'
									}
								},
								radius: pieRadius,
								data: [
									{name: 'samochody', value: Math.round(Math.random() * 24)},
									{name: 'rowery', value: Math.round(Math.random() * 24)},
									{name: 'piesi', value: Math.round(Math.random() * 24)}
								]
							};
						});
					}

					function getPieSeriesUpdate(scatterData, chart) {
						return echarts.util.map(scatterData, function (item, index) {
							var center = chart.convertToPixel('calendar', item);
							return {
								id: index + 'pie',
								center: center
							};
						});
					}

					var scatterData = getVirtulData();

					option = {
						tooltip : {},
						legend: {
							data: ['samochody', 'rowery', 'piesi'],
							bottom: 20
						},
						calendar: {
							top: 'middle',
							left: 'center',
							orient: 'vertical',
							cellSize: cellSize,
							yearLabel: {
								show: false,
								textStyle: {
									fontSize: 30
								}
							},
							dayLabel: {
								margin: 20,
								firstDay: 1,
								nameMap: ['nd', 'pn', 'wt', 'śr', 'cz', 'pt', 'sb']
							},
							monthLabel: {
								show: false
							},
							range: ['2017-02']
						},
						series: [{
							id: 'label',
							type: 'scatter',
							coordinateSystem: 'calendar',
							symbolSize: 1,
							label: {
								normal: {
									show: true,
									formatter: function (params) {
										return echarts.format.formatTime('dd', params.value[0]);
									},
									offset: [-cellSize[0] / 2 + 10, -cellSize[1] / 2 + 10],
									textStyle: {
										color: '#000',
										fontSize: 14
									}
								}
							},
							data: scatterData
						}]
					};

					var pieInitialized;
					setTimeout(function () {
						pieInitialized = true;
						myChart.setOption({
							series: getPieSeries(scatterData, myChart)
						});
					}, 10);

					app.onresize = function () {
						if (pieInitialized) {
							myChart.setOption({
								series: getPieSeriesUpdate(scatterData, myChart)
							});
						}
						myChart.resize();
					};
					
					if (option && typeof option === "object") {
						myChart.setOption(option, true);
					}
				}
			</script> 
		<div class="row">
		  <div class="col-sm-6" id="barchart" style="width: 100%; min-height: 400px">
		  </div>  
		  <div class="col-sm-6" id="piecalendar" style="width: 100%; min-height: 400px">
		  </div>
		</div>
		
      </div>
	</div>
		

    <script src="js/jquery.min.js"></script>
    <script src="js/popper.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>